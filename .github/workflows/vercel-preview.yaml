name: Vercel Preview Deployment
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
on:
  push:
    branches-ignore:
      - main
jobs:
  Deploy-Preview:
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{steps.deploy_to_vercel.outputs.preview-url}}
    steps:
      - uses: actions/checkout@v2
      - name: Slack notification for preview deployment started
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          # Accepts channel name but setting a channel ID here for consistency is highly recommended.
          channel-id: "C0348R118A3"
          payload: |
            {
              "text": "Preview deployment of '${{ github.ref_name }}' branch started.",
              "username": "Preview Deployment Notification",
              "icon_emoji": ":rocket:",
              "attachments": [
                {
                  "color": "dbab09",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "In Progress"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        run: echo "preview-url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})" >> $GITHUB_OUTPUT
        id: deploy_to_vercel
      - name: Slack notification for preview deployment completed
        if: success()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          # Please use a channel ID, not a name here.
          channel-id: "C0348R118A3"
          update-ts: ${{ steps.slack.outputs.ts }}
          payload: |
            {
              "text": "Preview deployment of '${{ github.ref_name }}' branch completed. <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|View deployment on Github>\n\n<${{steps.deploy_to_vercel.outputs.preview-url}}|View Preview on Vercel>",
              "username": "Preview Deployment Notification",
              "icon_emoji": ":rocket:",
              "attachments": [
                {
                  "color": "28a745",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "${{ job.status }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
      - name: Slack notification for preview deployment failed
        if: failure()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          # Please use a channel ID, not a name here.
          channel-id: "C0348R118A3"
          update-ts: ${{ steps.slack.outputs.ts }}
          payload: |
            {
              "text": "Preview deployment of '${{ github.ref_name }}' branch failed. <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|View deployment on Github>",
              "username": "Preview Deployment Notification",
              "icon_emoji": ":rocket:",
              "attachments": [
                {
                  "color": "ff0000",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "${{ job.status }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
